openapi: 3.1.0
info:
  title: StoreBook API
  version: 1.0.0
  description: |
    Laravel 12 modular monolith API for StoreBook.
    Auth uses Sanctum Bearer tokens.
servers:
  - url: http://{host}:8000/api
    description: StoreBook API server for local, emulator, or LAN usage.
    variables:
      host:
        default: localhost
        description: Use localhost or 127.0.0.1 for local web, 10.0.2.2 for Android emulator, or your LAN IPv4 for physical devices.
security:
  - bearerAuth: []
paths:
  /auth/register:
    post:
      tags: [Auth]
      security: []
      summary: Register a client user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithAuthPayload'
  /auth/login:
    post:
      tags: [Auth]
      security: []
      summary: Login and receive bearer token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithAuthPayload'
  /auth/me:
    get:
      tags: [Auth]
      summary: Get authenticated user profile
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithUser'
  /auth/logout:
    post:
      tags: [Auth]
      summary: Revoke current token
      responses:
        '200':
          description: Logout success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
  /catalog/books:
    get:
      tags: [Catalog]
      security: []
      summary: List books with search/filter/sort
      parameters:
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: category_id
          schema: { type: integer }
        - in: query
          name: genre_id
          schema: { type: integer }
        - in: query
          name: sort
          schema:
            type: string
            enum: [newest, price_asc, price_desc, title_asc]
        - in: query
          name: per_page
          schema: { type: integer, minimum: 1, maximum: 50 }
      responses:
        '200':
          description: Books list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithBookList'
  /catalog/books/{book}:
    get:
      tags: [Catalog]
      security: []
      summary: Get a single book
      parameters:
        - in: path
          name: book
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Book details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithBook'
  /cart:
    get:
      tags: [Cart]
      summary: Get active cart for current user
      responses:
        '200':
          description: Cart state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithCart'
  /cart/items:
    post:
      tags: [Cart]
      summary: Add book to cart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [book_id]
              properties:
                book_id: { type: integer }
                quantity: { type: integer, minimum: 1 }
      responses:
        '200':
          description: Cart updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithCart'
    delete:
      tags: [Cart]
      summary: Clear current cart
      responses:
        '200':
          description: Cart cleared
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithCart'
  /cart/items/{cartItem}:
    patch:
      tags: [Cart]
      summary: Update cart item quantity
      parameters:
        - in: path
          name: cartItem
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [quantity]
              properties:
                quantity: { type: integer, minimum: 1 }
      responses:
        '200':
          description: Cart updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithCart'
    delete:
      tags: [Cart]
      summary: Remove a cart item
      parameters:
        - in: path
          name: cartItem
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Cart updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithCart'
  /orders:
    get:
      tags: [Orders]
      summary: List current user orders
      responses:
        '200':
          description: Orders list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithOrderList'
    post:
      tags: [Orders]
      summary: Create order from current cart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address_id, payment_method]
              properties:
                address_id: { type: integer }
                payment_method:
                  type: string
                  enum: [cash_on_delivery, bank_transfer, card]
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithOrder'
  /orders/{order}:
    get:
      tags: [Orders]
      summary: Get single order (owner or admin)
      parameters:
        - in: path
          name: order
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithOrder'
  /admin/dashboard:
    get:
      tags: [Admin]
      summary: Admin dashboard metrics
      responses:
        '200':
          description: Dashboard metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
  /admin/orders/{order}/status:
    patch:
      tags: [Admin]
      summary: Update order status
      parameters:
        - in: path
          name: order
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [pending, paid, processing, shipped, completed, cancelled]
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeWithOrder'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Envelope:
      type: object
      required: [success, message]
      properties:
        success: { type: boolean }
        message: { type: string }
        data: {}
        meta:
          type: object
        errors:
          type: object
    PaginationMeta:
      type: object
      properties:
        current_page: { type: integer }
        last_page: { type: integer }
        per_page: { type: integer }
        total: { type: integer }
        from: { type: integer, nullable: true }
        to: { type: integer, nullable: true }
    User:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        email: { type: string }
        roles:
          type: array
          items: { type: string }
    Book:
      type: object
      properties:
        id: { type: integer }
        title: { type: string }
        author: { type: string }
        description: { type: string }
        price_cents: { type: integer }
        stock_quantity: { type: integer }
        status: { type: string }
    Cart:
      type: object
      properties:
        id: { type: integer, nullable: true }
        item_count: { type: integer }
        subtotal_cents: { type: integer }
        items:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              quantity: { type: integer }
              unit_price_cents: { type: integer }
              total_price_cents: { type: integer }
              book:
                $ref: '#/components/schemas/Book'
    Order:
      type: object
      properties:
        id: { type: integer }
        status: { type: string }
        payment_status: { type: string }
        subtotal_cents: { type: integer }
        total_cents: { type: integer }
        items:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              title_snapshot: { type: string }
              quantity: { type: integer }
              total_price_cents: { type: integer }
    RegisterRequest:
      type: object
      required: [name, email, password]
      properties:
        name: { type: string }
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        device_name: { type: string }
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        device_name: { type: string }
    EnvelopeWithUser:
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/User'
    EnvelopeWithAuthPayload:
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              type: object
              properties:
                token: { type: string }
                token_type: { type: string, example: Bearer }
                user:
                  $ref: '#/components/schemas/User'
    EnvelopeWithBook:
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Book'
    EnvelopeWithBookList:
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Book'
            meta:
              type: object
              properties:
                pagination:
                  $ref: '#/components/schemas/PaginationMeta'
    EnvelopeWithCart:
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Cart'
    EnvelopeWithOrder:
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Order'
    EnvelopeWithOrderList:
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Order'
            meta:
              type: object
              properties:
                pagination:
                  $ref: '#/components/schemas/PaginationMeta'
